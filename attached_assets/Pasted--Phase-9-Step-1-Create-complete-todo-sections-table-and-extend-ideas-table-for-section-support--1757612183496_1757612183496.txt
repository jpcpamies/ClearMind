-- Phase 9 Step 1: Create complete todo_sections table and extend ideas table for section support

-- Drop existing todo_sections table if it exists and recreate with full structure
DROP TABLE IF EXISTS todo_sections CASCADE;

CREATE TABLE todo_sections (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) NOT NULL,
  group_id UUID NOT NULL REFERENCES groups(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  section_order INTEGER NOT NULL DEFAULT 0,
  is_collapsed BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Add section support to ideas table
ALTER TABLE ideas 
ADD COLUMN IF NOT EXISTS section_id UUID REFERENCES todo_sections(id) ON DELETE SET NULL,
ADD COLUMN IF NOT EXISTS task_order INTEGER DEFAULT 0;

-- Create indexes for optimal performance
CREATE INDEX idx_todo_sections_group_order ON todo_sections(group_id, section_order);
CREATE INDEX idx_todo_sections_user ON todo_sections(user_id);
CREATE INDEX idx_ideas_section_order ON ideas(section_id, task_order) WHERE section_id IS NOT NULL;

-- Set default task_order for all existing ideas
UPDATE ideas SET task_order = 0 WHERE task_order IS NULL;

-- Insert sample sections for testing with user faf99abd-3583-4764-90fe-05af5b649f0a
INSERT INTO todo_sections (name, group_id, user_id, section_order) VALUES 
('Planning & Research', '3320f19b-b4c8-49ca-a3a8-0c40e4c92043', 'faf99abd-3583-4764-90fe-05af5b649f0a', 1),
('Development Tasks', '3320f19b-b4c8-49ca-a3a8-0c40e4c92043', 'faf99abd-3583-4764-90fe-05af5b649f0a', 2),
('Testing & Review', '3320f19b-b4c8-49ca-a3a8-0c40e4c92043', 'faf99abd-3583-4764-90fe-05af5b649f0a', 3),
('Content Creation', '7a1c05c1-95d4-47b7-8f74-696390e98d5c', 'faf99abd-3583-4764-90fe-05af5b649f0a', 1),
('Video Production', '7a1c05c1-95d4-47b7-8f74-696390e98d5c', 'faf99abd-3583-4764-90fe-05af5b649f0a', 2);

-- Verify the schema changes
SELECT 
  table_name, 
  column_name, 
  data_type, 
  is_nullable 
FROM information_schema.columns 
WHERE table_name IN ('todo_sections', 'ideas') 
ORDER BY table_name, ordinal_position;

-- Verify sample data insertion
SELECT ts.name, g.name as group_name, ts.section_order 
FROM todo_sections ts 
JOIN groups g ON ts.group_id = g.id 
WHERE ts.user_id = 'faf99abd-3583-4764-90fe-05af5b649f0a'
ORDER BY g.name, ts.section_order;